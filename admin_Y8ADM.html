<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ì¶œì„ë¶€ ê´€ë¦¬ì</title>
    <style>
        body {
            font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
            margin: 24px;
            background: #f8f9fa;
        }

        h2 {
            margin-bottom: 6px;
            color: #333;
        }

        .row {
            margin: 10px 0;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        select, input, button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        button:hover {
            background: #5568d3;
        }

        .summary {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .summary-card {
            background: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-width: 120px;
        }

        .summary-card .label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .summary-card .value {
            font-size: 24px;
            font-weight: bold;
        }

        .summary-card.present .value {
            color: #28a745;
        }

        .summary-card.absent .value {
            color: #dc3545;
        }

        .summary-card.total .value {
            color: #667eea;
        }

        label {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 14px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .present {
            color: #28a745;
            font-weight: 700;
        }

        .absent {
            color: #dc3545;
        }

        .time {
            font-size: 12px;
            color: #666;
        }

        .btn {
            cursor: pointer;
            padding: 6px 12px;
            font-size: 13px;
            border-radius: 4px;
        }

        .btn-download {
            background: #28a745;
            margin-left: auto;
        }

        .btn-download:hover {
            background: #218838;
        }
    </style>
</head>
<body>

    <h2>ğŸ“‹ ì²­ì†Œë…„ë¶€ ì¶œì„ ê´€ë¦¬ì</h2>

    <div class="row">
        <label>ë‚ ì§œ:</label>
        <input type="date" id="dateInput" />

        <label>í•™ë…„:</label>
        <select id="gradeFilter">
            <option value="">ì „ì²´</option>
        </select>

        <label>
            <input type="checkbox" id="absentOnly" />
            ê²°ì„ìë§Œ ë³´ê¸°
        </label>

        <button id="btnSearch">ì¡°íšŒ</button>
        <button id="btnDownload" class="btn-download">ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ</button>
    </div>

    <div class="summary" id="summary"></div>

    <table>
        <thead>
            <tr>
                <th>ì´ë¦„</th>
                <th>í•™ë…„</th>
                <th>ë°˜</th>
                <th>ì¶œì„ ì—¬ë¶€</th>
                <th>ì¶œì„ ì‹œê°„</th>
                <th>ê´€ë¦¬</th>
            </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

        /*********************************************************
         * Supabase ì„¤ì •
         *********************************************************/
        const SUPABASE_URL = "https://ketjtbjvtiveyswigtxb.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtldGp0Ymp2dGl2ZXlzd2lndHhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2MTA0NTcsImV4cCI6MjA4NTE4NjQ1N30.3cUg9ZJM5Qf_VJAWvJgArPsG0XAXH7qigEAeJeDroOY";
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        /*********************************************************
         * DOM
         *********************************************************/
        const tbody = document.getElementById("tbody");
        const dateInput = document.getElementById("dateInput");
        const gradeFilter = document.getElementById("gradeFilter");
        const btnSearch = document.getElementById("btnSearch");
        const btnDownload = document.getElementById("btnDownload");
        const absentOnly = document.getElementById("absentOnly");
        const summary = document.getElementById("summary");

        let currentData = [];

        /*********************************************************
         * ìœ í‹¸
         *********************************************************/
        function todayKST() {
            const d = new Date(
                new Date().toLocaleString("en-US", { timeZone: "Asia/Seoul" })
            );
            return d.toISOString().slice(0, 10);
        }

        function formatTime(isoString) {
            if (!isoString) return "-";
            const d = new Date(isoString);
            const hours = d.getHours().toString().padStart(2, '0');
            const minutes = d.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        dateInput.value = todayKST();

        /*********************************************************
         * í•™ë…„ ëª©ë¡ ë¡œë”©
         *********************************************************/
        async function loadGrades() {
            const { data, error } = await supabase
                .from("students")
                .select("grade")
                .neq("grade", null);

            if (error) {
                alert("í•™ë…„ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: " + error.message);
                return;
            }

            const grades = [...new Set(data.map(d => d.grade))].sort();
            grades.forEach(g => {
                const opt = document.createElement("option");
                opt.value = g;
                opt.textContent = g;
                gradeFilter.appendChild(opt);
            });
        }

        /*********************************************************
         * ì¶œì„ ìš”ì•½ í‘œì‹œ
         *********************************************************/
        function displaySummary(data) {
            const presentCount = data.filter(s => s.isPresent).length;
            const absentCount = data.filter(s => !s.isPresent).length;
            const totalCount = data.length;

            summary.innerHTML = `
                <div class="summary-card present">
                    <div class="label">ì¶œì„</div>
                    <div class="value">${presentCount}ëª…</div>
                </div>
                <div class="summary-card absent">
                    <div class="label">ê²°ì„</div>
                    <div class="value">${absentCount}ëª…</div>
                </div>
                <div class="summary-card total">
                    <div class="label">ì „ì²´</div>
                    <div class="value">${totalCount}ëª…</div>
                </div>
            `;
        }

        /*********************************************************
         * ì¶œì„ ë°ì´í„° ì¡°íšŒ
         *********************************************************/
        async function loadData() {
            tbody.innerHTML = "";

            const date = dateInput.value;
            const grade = gradeFilter.value;
            const showAbsentOnly = absentOnly.checked;

            // 1. í•™ìƒ ëª©ë¡ ì¡°íšŒ
            let studentQuery = supabase
                .from("students")
                .select("id, name, grade, class_name")
                .eq("is_active", true);

            if (grade) {
                studentQuery = studentQuery.eq("grade", grade);
            }

            const { data: students, error: studentError } = await studentQuery.order("name");
            
            if (studentError) {
                alert("ì¡°íšŒ ì˜¤ë¥˜: " + studentError.message);
                return;
            }

            if (students.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6">ì¡°íšŒëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                summary.innerHTML = "";
                return;
            }

            // 2. í•´ë‹¹ ë‚ ì§œì˜ ì¶œì„ ê¸°ë¡ ì¡°íšŒ
            const { data: attendanceRecords, error: attendanceError } = await supabase
                .from("attendance")
                .select("student_id, attend_time")
                .eq("attend_date", date);

            if (attendanceError) {
                alert("ì¶œì„ ê¸°ë¡ ì¡°íšŒ ì˜¤ë¥˜: " + attendanceError.message);
                return;
            }

            // 3. ì¶œì„ ê¸°ë¡ì„ Mapìœ¼ë¡œ ë³€í™˜
            const attendanceMap = new Map();
            attendanceRecords.forEach(record => {
                attendanceMap.set(record.student_id, record.attend_time);
            });

            // 4. í•™ìƒ ë°ì´í„°ì™€ ì¶œì„ ê¸°ë¡ ê²°í•©
            currentData = students.map(student => ({
                ...student,
                isPresent: attendanceMap.has(student.id),
                attendTime: attendanceMap.get(student.id) || null
            }));

            // 5. ê²°ì„ìë§Œ ë³´ê¸° í•„í„°
            const filteredData = showAbsentOnly 
                ? currentData.filter(s => !s.isPresent)
                : currentData;

            // 6. ìš”ì•½ í‘œì‹œ
            displaySummary(currentData);

            // 7. í…Œì´ë¸” ë Œë”ë§
            if (filteredData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6">ì¡°íšŒëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                return;
            }

            filteredData.forEach(student => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${student.name}</td>
                    <td>${student.grade || ""}</td>
                    <td>${student.class_name || ""}</td>
                    <td class="${student.isPresent ? "present" : "absent"}">
                        ${student.isPresent ? "ì¶œì„" : "ê²°ì„"}
                    </td>
                    <td class="time">${formatTime(student.attendTime)}</td>
                    <td>
                        <button class="btn" data-id="${student.id}" data-present="${student.isPresent}">
                            ${student.isPresent ? "ê²°ì„ ì²˜ë¦¬" : "ì¶œì„ ì²˜ë¦¬"}
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        /*********************************************************
         * CSV ë‹¤ìš´ë¡œë“œ
         *********************************************************/
        function downloadCSV() {
            const date = dateInput.value;
            const headers = ['ì´ë¦„', 'í•™ë…„', 'ë°˜', 'ì¶œì„ì—¬ë¶€', 'ì¶œì„ì‹œê°„'];
            const rows = currentData.map(s => [
                s.name,
                s.grade || '',
                s.class_name || '',
                s.isPresent ? 'ì¶œì„' : 'ê²°ì„',
                formatTime(s.attendTime)
            ]);

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ì¶œì„ë¶€_${date}.csv`;
            link.click();
        }

        /*********************************************************
         * ì¶œì„ í† ê¸€ (ì´ë²¤íŠ¸ ìœ„ì„)
         *********************************************************/
        tbody.addEventListener("click", async (e) => {
            const btn = e.target.closest("button");
            if (!btn) return;

            const studentId = Number(btn.dataset.id);
            const isPresent = btn.dataset.present === "true";
            const date = dateInput.value;

            if (isPresent) {
                // ê²°ì„ ì²˜ë¦¬
                await supabase
                    .from("attendance")
                    .delete()
                    .eq("student_id", studentId)
                    .eq("attend_date", date);
            } else {
                // ì¶œì„ ì²˜ë¦¬
                await supabase
                    .from("attendance")
                    .insert({
                        student_id: studentId,
                        attend_date: date,
                        source: "admin_manual"
                    });
            }

            loadData();
        });

        /*********************************************************
         * ì´ë²¤íŠ¸ ë°”ì¸ë”©
         *********************************************************/
        btnSearch.addEventListener("click", loadData);
        btnDownload.addEventListener("click", downloadCSV);
        gradeFilter.addEventListener("change", loadData);
        dateInput.addEventListener("change", loadData);
        absentOnly.addEventListener("change", loadData);

        /*********************************************************
         * ì´ˆê¸° ë¡œë”©
         *********************************************************/
        await loadGrades();
        await loadData();
    </script>

</body>
</html>
