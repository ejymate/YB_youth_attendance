<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ì¶œì„ë¶€ ê´€ë¦¬ì</title>
    <style>
        body {
            font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
            margin: 24px;
        }

        h2 {
            margin-bottom: 6px;
        }

        .row {
            margin: 10px 0;
        }

        select, input, button {
            padding: 6px 10px;
            margin-right: 6px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 14px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: center;
        }

        th {
            background: #f5f5f5;
        }

        .present {
            color: green;
            font-weight: 700;
        }

        .absent {
            color: #999;
        }

        .btn {
            cursor: pointer;
            padding: 4px 8px;
            font-size: 13px;
        }
    </style>
</head>
<body>

    <h2>ğŸ“‹ ì²­ì†Œë…„ë¶€ ì¶œì„ ê´€ë¦¬ì</h2>

    <div class="row">
        <label>ë‚ ì§œ:</label>
        <input type="date" id="dateInput" />

        <label>í•™ë…„:</label>
        <select id="gradeFilter">
            <option value="">ì „ì²´</option>
        </select>

        <button id="btnSearch">ì¡°íšŒ</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>ì´ë¦„</th>
                <th>í•™ë…„</th>
                <th>ë°˜</th>
                <th>ì¶œì„ ì—¬ë¶€</th>
                <th>ê´€ë¦¬</th>
            </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

        /*********************************************************
         * Supabase ì„¤ì •
         *********************************************************/
        const SUPABASE_URL = "https://ketjtbjvtiveyswigtxb.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtldGp0Ymp2dGl2ZXlzd2lndHhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2MTA0NTcsImV4cCI6MjA4NTE4NjQ1N30.3cUg9ZJM5Qf_VJAWvJgArPsG0XAXH7qigEAeJeDroOY";
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        /*********************************************************
         * DOM
         *********************************************************/
        const tbody = document.getElementById("tbody");
        const dateInput = document.getElementById("dateInput");
        const gradeFilter = document.getElementById("gradeFilter");
        const btnSearch = document.getElementById("btnSearch");

        /*********************************************************
         * ìœ í‹¸
         *********************************************************/
        function todayKST() {
            const d = new Date(
                new Date().toLocaleString("en-US", { timeZone: "Asia/Seoul" })
            );
            return d.toISOString().slice(0, 10);
        }

        dateInput.value = todayKST();

        /*********************************************************
         * í•™ë…„ ëª©ë¡ ë¡œë”©
         *********************************************************/
        async function loadGrades() {
            const { data, error } = await supabase
                .from("students")
                .select("grade")
                .neq("grade", null);

            if (error) {
                alert("í•™ë…„ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: " + error.message);
                return;
            }

            const grades = [...new Set(data.map(d => d.grade))];
            grades.forEach(g => {
                const opt = document.createElement("option");
                opt.value = g;
                opt.textContent = g;
                gradeFilter.appendChild(opt);
            });
        }

        /*********************************************************
         * ì¶œì„ ë°ì´í„° ì¡°íšŒ
         *********************************************************/
        async function loadData() {
            tbody.innerHTML = "";

            const date = dateInput.value;
            const grade = gradeFilter.value;

            let query = supabase
                .from("students")
                .select(`
            id,
            name,
            grade,
            class_name,
            attendance(attend_date)
          `)
                .eq("is_active", true);

            if (grade) {
                query = query.eq("grade", grade);
            }

            const { data, error } = await query.order("name");
            if (error) {
                alert("ì¡°íšŒ ì˜¤ë¥˜: " + error.message);
                return;
            }

            if (data.length === 0) {
                tbody.innerHTML =
                    `<tr><td colspan="5">ì¡°íšŒëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                return;
            }

            data.forEach(student => {
                const isPresent =
                    student.attendance.some(a => a.attend_date === date);

                const tr = document.createElement("tr");
                tr.innerHTML = `
            <td>${student.name}</td>
            <td>${student.grade || ""}</td>
            <td>${student.class_name || ""}</td>
            <td class="${isPresent ? "present" : "absent"}">
              ${isPresent ? "ì¶œì„" : "ê²°ì„"}
            </td>
            <td>
              <button class="btn" data-id="${student.id}" data-present="${isPresent}">
                ${isPresent ? "ê²°ì„ ì²˜ë¦¬" : "ì¶œì„ ì²˜ë¦¬"}
              </button>
            </td>
          `;
                tbody.appendChild(tr);
            });
        }

        /*********************************************************
         * ì¶œì„ í† ê¸€ (ì´ë²¤íŠ¸ ìœ„ì„)
         *********************************************************/
        tbody.addEventListener("click", async (e) => {
            const btn = e.target.closest("button");
            if (!btn) return;

            const studentId = Number(btn.dataset.id);
            const isPresent = btn.dataset.present === "true";
            const date = dateInput.value;

            if (isPresent) {
                // ê²°ì„ ì²˜ë¦¬
                await supabase
                    .from("attendance")
                    .delete()
                    .eq("student_id", studentId)
                    .eq("attend_date", date);
            } else {
                // ì¶œì„ ì²˜ë¦¬
                await supabase
                    .from("attendance")
                    .upsert(
                        { student_id: studentId, attend_date: date },
                        { onConflict: "student_id,attend_date" }
                    );
            }

            loadData();
        });

        /*********************************************************
         * ì´ë²¤íŠ¸ ë°”ì¸ë”©
         *********************************************************/
        btnSearch.addEventListener("click", loadData);
        gradeFilter.addEventListener("change", loadData);
        dateInput.addEventListener("change", loadData);

        /*********************************************************
         * ì´ˆê¸° ë¡œë”©
         *********************************************************/
        await loadGrades();
        await loadData();
    </script>

</body>
</html>
